<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Demo AUC Guidance App</title>
</head>

<body>
  <div>
    <form action="http://localhost:3002/evaluate" method="POST">
      <input type="hidden" id="provider" name="provider">
      <table>
        <caption>Enter Patient Demographics</caption>
        <tr>
          <th><label for="gender">Gender</label></th>
          <td>
            <select name="gender" required>
              <option id="male" value="male">Male</option>
              <option id="female" value="female">Female</option>
              <option id="other" value="other">Other</option>
            </select>
          </td>
        </tr>
        <tr>
          <th><label for="age">Age</label></th>
          <td><input id="age" name="age" required></td>
        </tr>
        <tr>
          <th><label for="indication">Indication</label></th>
          <td>
            <input id="indications" list="indicationsData" name="indication" required>
            <datalist id="indicationsData">
              <option id="13213009" value="13213009">congenital heart disease</option>
              <option id="25064002" value="25064002">headache</option>
              <option id="279039007" value="279039007">lower back pain</option>
              <option id="423341008" value="423341008">optic disc edema</option>
              <option id="27355003" value="27355003">toothache</option>
            </datalist>
          </td>
        </tr>
        <tr>
          <th><label for="procedure">Procedure</label></th>
          <td>
            <input id="orders" list="proceduresData" name="procedure" required>
            <datalist id="proceduresData">
              <option id="75561" value="75561">cardiac mri</option>
              <option id="70450" value="70450">ct scan - no contrast material</option>
              <option id="71275" value="71275">cta - with contrast material</option>
              <option id="72133" value="72133">lumbar spine ct scan</option>
              <option id="70544" value="70544">mra - head</option>
            </datalist>
          </td>
        </tr>
      </table>
      <input type="submit">
    </form>
  </div>

  <script src="node_modules/fhirclient/build/fhir-client.js"></script>
  <script>

    async function getContext(client) {
      const context = JSON.parse(client.state.tokenResponse.appContext || '{}');
      const indications = context.indications || [-1];
      const orders = context.orders || [-1];
      return {
        indication: indications.pop(),
        order: orders.pop(),
        patient: await client.patient.read(),
        user: await client.user.read(),
      };
    }

    function populateForm(context) {
      const patient = context.patient;
      const then = new Date(patient.birthDate),
        now = new Date();
      const msPerYear = 365.25 * 24 * 60 * 60 * 1000;
      const age = (now.getTime() - then.getTime()) / msPerYear;

      document.getElementById('provider').value = context.user.id;
      document.getElementById('age').value = Math.round(age);
      document.getElementById(context.patient.gender).setAttribute('selected', 1);
      if (context.indication !== -1) {
        document.getElementById('indications').value = context.indication;
      }
      if (context.order !== -1) {
        document.getElementById('orders').value = context.order;
      }
    }

    if (typeof FHIR === 'undefined') {
      throw new Error('Unable to load the FHIR client.  Halting page load.');
    }

    FHIR.oauth2.ready()
      .then(getContext)
      .then(populateForm)
      .catch(console.error);

  </script>

</body>

</html>
